general:
  artifacts:
    - docker

machine:
  services:
    - docker

dependencies:
  cache_directories:
    - ~/docker
  override:
    - docker info
    - if [[ -e ~/docker/builder.tar ]]; then docker load --input ~/docker/builder.tar; fi
    - docker build -t middleman-builder .
    - docker run --name middleman-builder middleman-builder
    - docker cp middleman-builder:/app/build.tar.gz ./images/nginx
    - docker build -t middleman images/nginx
    - docker save middleman | gzip -c > docker/middleman_docker_image.tar.gz
    - mkdir -p ~/docker; docker save middleman-builder > ~/docker/builder.tar
    - docker images

test:
  override:
    - echo 'No tests :('

compile:
  override:
    - echo 'Do not run bundle exec middleman build!'

deployment:
  staging:
    branch: master
    codedeploy:
      docker-test:
        application_root: /
        region: us-east-1
        revision_location:
          revision_type: S3
          s3_location:
            bucket: docker-test-bucket-neilni
            key_pattern: docker-test-bucket-neilni-{BRANCH}-{SHORT_COMMIT}
        deployment_group: docker-test-gp
